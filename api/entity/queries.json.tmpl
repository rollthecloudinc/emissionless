{{ define "adlistitems" }}
{
	"query": {
		"bool": {
			"filter": [
				{
					"bool": {
						"must": [
							{
								"term": {
									"typeId.keyword": {
										"value": "{{ index . "typeId" 0 }}"
									}
								}
							}
                            {{ with .location }}{{ if eq (len .) 2 }},
							{
								"geo_distance": {
									"validation_method": "ignore_malformed",
									"distance": "10m",
									"distance_type": "arc",
									"location": {
										"lat": {{ index . 1 }},
										"lon": {{ index . 0 }}
									}
								}
							}
                            {{ end }}{{ end }}
						]
					}
				}
			],
			"must": [
                {{ with .searchString }}
				{
					"match": {
						"title": {
							"query": "{{ index . 0 }}"
						}
					}
				}
                {{ end }}
                {{ with .features }}{{ if $.searchString }},{{ end }}
				{
					"nested": {
						"path": "featureSets",
						"query": {
                            "nested": {
                                "path": "featureSets.terms",
                                "query": {
                                    "bool": {
								        "must": [
                                            {{ range $index, $feature := . }}{{ if ne $index 0 }},{{ end }}
									        { 
                                                "match": { 
                                                    "featureSets.terms.humanName": "{{ $feature }}" 
                                                } 
                                            }
                                            {{ end }}
                                        ]
								    }
                                }
                            }
						}
					}
				}
                {{ end }}
			]
		}
	}
}
{{end}}